<!DOCTYPE html>
<html>
  <head>
    <title>File Reader Example</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <h1>PDF Komprimieren</h1>
    <h2>Ausw√§hlen</h2>
    <input type="file" id="fileInput" />
    <h2>Hochladen</h2>
    <button id="submitButton">Submit</button>
    <h2>Ergebnis</h2>
    <div id="statusText"></div>
    <div id="resultDiv"></div>

    <script>
      const fileInput = document.getElementById('fileInput');
      const submitButton = document.getElementById('submitButton');
      const statusText = document.getElementById('statusText');
      const resultDiv = document.getElementById('resultDiv');

      function uuidv4() {
        return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, (c) =>
          (c ^ (crypto.getRandomValues(new Uint8Array(1))[0] & (15 >> (c / 4)))).toString(16),
        );
      }

      async function updateStatusText(msg) {
        statusText.innerHTML = msg;
        return;
      }

      async function upload(formData) {
        console.log('UPLOAD');
        resultDiv.innerHTML = '';
        updateStatusText('‚õÖ uploading file...');
        fetch('http://192.168.178.32:4455/upload', {
          method: 'POST',
          body: formData,
        })
          .then((res) => res.json())
          .then((res) => {
            console.log(res);
            console.log(res.msg);
            updateStatusText('üéâ Erfolg');
            const linkEl = document.createElement('a');
            const pdfName = 'c-' + res.compressedPdf.fileName;
            linkEl.href = `http://192.168.178.32:4455/download?fileName=${encodeURIComponent(
              pdfName,
            )}&uuid=${encodeURIComponent(res.compressedPdf.uuid)}`;
            linkEl.text = `${res.compressedPdf.uuid}/${pdfName}`;
            resultDiv.appendChild(linkEl);
            return;
          })
          .catch((error) => {
            console.log(error);
            updateStatusText('üò• Fehler: ', error);
            return;
          });
      }

      submitButton.addEventListener('click', (event) => {
        console.log('SUBMIT');
        const file = fileInput.files[0];
        const reader = new FileReader();

        updateStatusText('üìñ reading file');
        reader.readAsArrayBuffer(file);
        console.log('CHECK FILETYPE');
        if (file.type !== 'application/pdf') {
          alert('Please select a PDF file.');
          return;
        }

        console.log('ON LOAD');
        reader.onload = () => {
          const formData = new FormData();
          const uuid = uuidv4();
          const pdfFile = reader.result;
          formData.append('uuid', uuid);
          formData.append('pdfFile', new Blob([pdfFile], { type: 'application/pdf' }), file.name);

          upload(formData);
        };
        reader.onerror = () => {
          console.log('Error reading file');
        };
      });
    </script>
  </body>
</html>
